# @universo/admin-backend

> üèóÔ∏è **–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–∞–∫–µ—Ç** - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ TypeScript-first —Å Express.js –∏ TypeORM

–ë—ç–∫–µ–Ω–¥-—Å–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏ (—Å—É–ø–µ—Ä–∞–¥–º–∏–Ω –∏ —Å—É–ø–µ—Ä–º–æ–¥–µ—Ä–∞—Ç–æ—Ä) —Å RBAC-—Å–∏—Å—Ç–µ–º–æ–π.

## –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞–∫–µ—Ç–µ

- **–í–µ—Ä—Å–∏—è**: 0.1.0
- **–¢–∏–ø**: Backend-—Å–µ—Ä–≤–∏—Å (TypeScript)
- **–°—Ç–∞—Ç—É—Å**: ‚úÖ –ê–∫—Ç–∏–≤–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
- **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**: Modern —Å Express.js + TypeORM + Zod –≤–∞–ª–∏–¥–∞—Ü–∏—è

## –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### üîê RBAC-—Å–∏—Å—Ç–µ–º–∞
- **–ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ä–æ–ª–∏**: superadmin, supermoderator —Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏
- **–£—Ä–æ–≤–Ω–∏ –¥–æ—Å—Ç—É–ø–∞**: 'view' (—Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ) –∏ 'manage' (–ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø)
- **–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ä–æ–ª–µ–π**: –õ–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è, —Ü–≤–µ—Ç–∞ –∏ –æ–ø–∏—Å–∞–Ω–∏—è

### üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è (`GLOBAL_ADMIN_ENABLED`)
- Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–µ–π –Ω–∞ —É—Ä–æ–≤–Ω–µ –∑–∞–ø—Ä–æ—Å–∞
- –ó–∞—â–∏—Ç–∞ –æ—Ç SQL-–∏–Ω—ä–µ–∫—Ü–∏–π —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å RLS —á–µ—Ä–µ–∑ PostgreSQL-—Ñ—É–Ω–∫—Ü–∏–∏

### üìä –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- TypeORM-—Å—É—â–Ω–æ—Å—Ç–∏ –≤ —Å—Ö–µ–º–µ `admin`
- PostgreSQL —Å JSONB –¥–ª—è –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
- –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥: TypeORM –¥–ª—è CRUD, SQL-—Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ —Å RLS

## API-—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫

### –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

```http
GET    /api/v1/admin/global-users          # –°–ø–∏—Å–æ–∫ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (view)
GET    /api/v1/admin/global-users/me       # –ü–æ–ª—É—á–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—É—é —Ä–æ–ª—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
GET    /api/v1/admin/global-users/stats    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞
POST   /api/v1/admin/global-users          # –ù–∞–∑–Ω–∞—á–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—É—é —Ä–æ–ª—å (manage)
PUT    /api/v1/admin/global-users/:id      # –û–±–Ω–æ–≤–∏—Ç—å —Ä–æ–ª—å/–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (manage)
DELETE /api/v1/admin/global-users/:id      # –û—Ç–æ–∑–≤–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø (manage)
```

### –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã —Ä–æ–ª–µ–π

```http
GET    /api/v1/admin/roles                 # –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ä–æ–ª–µ–π
GET    /api/v1/admin/roles/global          # –°–ø–∏—Å–æ–∫ —Ä–æ–ª–µ–π —Å –≥–ª–æ–±–∞–ª—å–Ω—ã–º –¥–æ—Å—Ç—É–ø–æ–º
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Express

```typescript
import { createGlobalUsersRoutes, createGlobalAccessService } from '@universo/admin-backend'
import { getDataSource } from '@universo/flowise-core-backend'

const globalAccessService = createGlobalAccessService({ getDataSource })
const globalUsersRoutes = createGlobalUsersRoutes({ globalAccessService })

app.use('/api/v1/admin/global-users', globalUsersRoutes)
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –≤ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª—è—Ö

```typescript
import { hasGlobalAccessByDataSource } from '@universo/admin-backend'
import { getDataSource } from '@universo/flowise-core-backend'

// –í –≤–∞—à–µ–º guard'–µ –¥–æ—Å—Ç—É–ø–∞
const hasAccess = await hasGlobalAccessByDataSource(getDataSource(), userId)
if (hasAccess) {
    // –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≤–ª–∞–¥–µ–ª—å—Ü–∞ –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –∞–¥–º–∏–Ω–æ–≤
}
```

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|------------|----------|--------------|
| `GLOBAL_ADMIN_ENABLED` | –í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å | `false` |

## –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### admin.roles

| –ö–æ–ª–æ–Ω–∫–∞ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|----------|
| id | UUID | –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á |
| name | VARCHAR(50) | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ä–æ–ª–∏ |
| display_name | JSONB | –õ–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è `{"en": "...", "ru": "..."}` |
| has_global_access | BOOLEAN | –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ |
| is_system | BOOLEAN | –ó–∞—â–∏—Ç–∞ –æ—Ç —É–¥–∞–ª–µ–Ω–∏—è |

### admin.user_roles

| –ö–æ–ª–æ–Ω–∫–∞ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|----------|
| id | UUID | –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á |
| user_id | UUID | –°—Å—ã–ª–∫–∞ –Ω–∞ auth.users |
| role_id | UUID | –°—Å—ã–ª–∫–∞ –Ω–∞ admin.roles |
| granted_by | UUID | –ê–¥–º–∏–Ω, –Ω–∞–∑–Ω–∞—á–∏–≤—à–∏–π —Ä–æ–ª—å |
| comment | TEXT | –ü—Ä–∏–º–µ—á–∞–Ω–∏—è –∫ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—é |

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥ SQL + TypeORM

–≠—Ç–æ—Ç –º–æ–¥—É–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ–¥—É–º–∞–Ω–Ω—ã–π –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥:

- **TypeORM Repository** –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö CRUD-–æ–ø–µ—Ä–∞—Ü–∏–π (–∑–∞–ø—Ä–æ—Å—ã —Ä–æ–ª–µ–π, —É–¥–∞–ª–µ–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π)
- **Raw SQL** –¥–ª—è PostgreSQL-—Ñ—É–Ω–∫—Ü–∏–π (`admin.has_global_access()`) –¥–ª—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ —Å RLS-–ø–æ–ª–∏—Ç–∏–∫–∞–º–∏

–¢–∞–∫–æ–π –¥–∏–∑–∞–π–Ω –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –≤ –∫–æ–¥–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Ç–æ—á–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç RLS-–ø–æ–ª–∏—Ç–∏–∫–∞–º –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –°–ø–∏—Å–æ–∫ —Ä–æ–ª–µ–π –∑–∞–≤–∏—Å–∞–µ—Ç –ø—Ä–∏ –ø—Ä—è–º–æ–º –ø–µ—Ä–µ—Ö–æ–¥–µ

- **–°–∏–º–ø—Ç–æ–º**: –ü—Ä–∏ –ø—Ä—è–º–æ–º –ø–µ—Ä–µ—Ö–æ–¥–µ –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ `/admin/instance/:id/roles` –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ—Å—Ç–∞—ë—Ç—Å—è –Ω–∞ —Å–∫–µ–ª–µ—Ç–æ–Ω–∞—Ö, –∞ –≤ Network –≤–∏—Å—è—Ç `GET /api/v1/admin/roles`.
- **–ü—Ä–∏—á–∏–Ω–∞**: –ü—Ä–æ–≤–µ—Ä–∫–∏ guard –≤—ã–ø–æ–ª–Ω—è–ª–∏—Å—å –≤–Ω–µ request-scoped RLS `QueryRunner`, –∫–æ–Ω–∫—É—Ä–∏—Ä–æ–≤–∞–ª–∏ –∑–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—É–ª–∞ –∏ –∏–Ω–æ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–ª–∏ –ø–æ—Å–ª–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è runner, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ `QueryRunnerAlreadyReleasedError` –∏–ª–∏ –∑–∞–≤–∏—Å—à–∏–º –∑–∞–ø—Ä–æ—Å–∞–º.
- **–†–µ—à–µ–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `QueryRunner` –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–æ–∫ –¥–æ—Å—Ç—É–ø–∞ –∏ –ø—Ä–∞–≤, –∞ –∫ `DataSource` –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ runner. –°—Ö–µ–º–∞ –ë–î –Ω–µ –º–µ–Ω—è–ª–∞—Å—å.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
packages/admin-backend/base/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ entities/          # TypeORM-—Å—É—â–Ω–æ—Å—Ç–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Role.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RolePermission.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ UserRole.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ migrations/        # –ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îú‚îÄ‚îÄ guards/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ensureGlobalAccess.ts
‚îÇ   ‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ globalUsersRoutes.ts
‚îÇ   ‚îú‚îÄ‚îÄ schemas/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts           # Zod-—Å—Ö–µ–º—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ globalAccessService.ts
‚îÇ   ‚îî‚îÄ‚îÄ index.ts               # –≠–∫—Å–ø–æ—Ä—Ç—ã –ø–∞–∫–µ—Ç–∞
‚îî‚îÄ‚îÄ package.json
```

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

| –ü–∞–∫–µ—Ç | –í–µ—Ä—Å–∏—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|-------|--------|------------|
| `express` | ^4.18.2 | HTTP-—Å–µ—Ä–≤–µ—Ä |
| `typeorm` | catalog | ORM –¥–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö |
| `zod` | ^3.25.76 | –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ö–µ–º |
| `http-errors` | catalog | –û–±—Ä–∞–±–æ—Ç–∫–∞ HTTP-–æ—à–∏–±–æ–∫ |

## –°–≤—è–∑–∞–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã

- `@universo/admin-frontend` - –§—Ä–æ–Ω—Ç–µ–Ω–¥ UI –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
- `@universo/auth-backend` - –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ guard'—ã –¥–æ—Å—Ç—É–ø–∞
- `@universo/types` - –û–±—â–∏–µ TypeScript-—Ç–∏–ø—ã
