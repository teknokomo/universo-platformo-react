# @universo/updl

> 🌐 UPDL (Universal Platform Definition Language) - Система определений узлов для создания универсальных 3D/AR/VR пространств

## Информация о пакете

| Поле | Значение |
|-------|-------|
| **Имя пакета** | `@universo/updl` |
| **Версия** | См. `package.json` |
| **Тип** | TypeScript-first (Определения узлов Flowise) |
| **Сборка** | ES модуль с ресурсами |
| **Назначение** | Система определений узлов для создания универсальных 3D/AR/VR пространств |

## 🚀 Ключевые возможности

- 🌐 **Universal Platform Definition Language** - Единый способ описания 3D пространств
- 🎯 **7 основных узлов** - Space, Entity, Component, Event, Action, Data, Universo
- 🔗 **Интеграция с Flowise** - Бесшовная интеграция через механизм NodesPool
- 🎨 **Поддержка технологий** - AR.js, PlayCanvas и другие через систему публикации
- 🌍 **Интернационализация** - Полная поддержка i18n
- ⚡ **TypeScript-first** - Полная типизация интерфейсов

## Описание

UPDL предоставляет набор специализированных определений узлов для редактора Flowise, позволяя пользователям создавать высокоуровневые абстрактные описания 3D пространств. Эти описания затем могут быть экспортированы в различные технологии (AR.js, PlayCanvas и другие) через приложения публикации.

## Архитектура

UPDL - это чистый модуль определений узлов, который бесшовно интегрируется с Flowise:

- **Только определения узлов**: Содержит только определения классов узлов Flowise
- **Без логики экспорта**: Вся функциональность построения и экспорта пространств обрабатывается системой публикации
- **Чистая интеграция**: Загружается в Flowise через механизм `NodesPool` из директории `dist/nodes`
- **Минимальные зависимости**: Содержит только зависимости, необходимые для определений узлов

## Структура

Исходный код имеет модульную структуру, каждый высокоуровневый узел находится в собственной директории.

```
src/
├── assets/              # Статические ресурсы (иконки)
│   └── icons/
├── i18n/                # Ресурсы интернационализации
├── interfaces/          # Основные TypeScript интерфейсы для экосистемы UPDL
│   └── UPDLInterfaces.ts
├── nodes/               # Определения узлов UPDL
│   ├── action/          # ActionNode: выполняет игровое действие
│   ├── base/            # BaseUPDLNode: общий базовый класс для всех узлов UPDL
│   ├── camera/          # CameraNode: определяет точку обзора
│   ├── component/       # ComponentNode: прикрепляет поведение к Entity
│   ├── data/            # DataNode: хранилище данных ключ-значение
│   ├── entity/          # EntityNode: представляет объект игры во время выполнения
│   ├── event/           # EventNode: запускает действия на основе событий
│   ├── light/           # LightNode: определяет освещение для пространства
│   ├── object/          # ObjectNode (Устаревший): определяет простой 3D объект
│   ├── space/           # SpaceNode: корневой контейнер для сцены
│   ├── universo/        # UniversoNode: глобальные настройки для MMOOMM
│   └── interfaces.ts    # Общие интерфейсы для узлов
└── index.ts             # Главная точка входа - экспортирует все классы узлов и интерфейсы
```

## Интеграция узлов

Модуль UPDL предоставляет определения узлов, которые интегрируются с редактором Flowise.

### Поддерживаемые типы узлов

Система UPDL построена вокруг **7 основных высокоуровневых узлов**, которые предоставляют полный фреймворк для описания интерактивных 3D/AR/VR опытов:

| Узел          | Назначение                                                          | Ключевые поля                          |
| ------------- | ------------------------------------------------------------------- | -------------------------------------- |
| **Space**     | Контейнеры сцен/экранов. Могут быть вложенными                      | id, type (root/module/block), settings |
| **Entity**    | Позиционированный объект/актор внутри Space                          | transform, tags                        |
| **Component** | Добавляет данные/поведение к Entity (render, sound, script)         | type, props                            |
| **Event**     | Триггер (OnStart, OnClick, OnTimer...)                              | eventType, source                      |
| **Action**    | Исполнитель (Move, PlaySound, SetData...)                           | actionType, target, params             |
| **Data**      | Хранилище значений; область видимости Local, Space, Global          | key, scope, value                      |
| **Universo**  | Шлюз к глобальной сети Kiberplano (GraphQL, MQTT UNS, OPC UA)       | transports, discovery, security        |

#### Поддержка основных узлов UPDL

Система шаблонов в первую очередь предназначена для обработки 7 основных высокоуровневых узлов UPDL:

-   **Space**: Контейнеры сцен/экранов
-   **Entity**: Позиционированные объекты/акторы
-   **Component**: Прикрепления поведения/данных
-   **Event**: Триггеры (OnStart, OnClick и т.д.)
-   **Action**: Исполнители (Move, PlaySound и т.д.)
-   **Data**: Хранилище ключ-значение
-   **Universo**: Глобальное сетевое подключение

**Примечание**: Другие узлы (Object, Camera, Light) являются устаревшими/тестовыми узлами и могут быть значительно изменены или удалены в будущих версиях. Сосредоточьте разработку на 7 основных узлах.

В типичной сцене **Entities** действуют как контейнеры для **Components**, которые добавляют поведение или визуалы. **Events**, прикрепленные к Entity, запускают **Actions**, когда происходят определенные условия. Эта цепочка `Entity → Component → Event → Action` определяет интерактивную логику пространства.

### Руководство по реализации коннекторов

Чтобы узлы корректно соединялись на холсте Flowise, следуйте этим правилам:

1.  **Входные коннекторы**: Чтобы родительский узел мог принять дочерний узел, определите соединение в массиве `inputs` класса родительского узла. `type` в определении входа должен соответствовать `name` дочернего узла (например, `type: 'UPDLEntity'`).

2.  **Выходные коннекторы**: Чтобы получить стандартный выходной коннектор, просто убедитесь, что массив `outputs` в классе узла пустой (`this.outputs = [];`). Flowise автоматически сгенерирует его. **Не** пытайтесь добавить выход по умолчанию в базовый класс, так как это сломает механизм.

3.  **Терминальные узлы**: Для узлов типа `ActionNode`, которые настраиваются внутренне и не соединяются с другими узлами, определите `inputs` и `outputs` как пустые массивы.

## Процесс сборки

Процесс сборки состоит из двух этапов:

1.  **Компиляция TypeScript**: Компилирует файлы TypeScript (`.ts`) в JavaScript (`.js`).
2.  **Задачи Gulp**: Копирует все статические ресурсы (например, SVG иконки) из исходных директорий в папку `dist`, сохраняя структуру директорий.

### Доступные скрипты

-   `pnpm clean` - Очищает директорию `dist`.
-   `pnpm build` - Собирает пакет (запускает компиляцию TypeScript и задачи Gulp).
-   `pnpm dev` - Запускает сборку в режиме разработки с отслеживанием файлов.
-   `pnpm lint` - Проверяет код линтером.

### Тестирование

```bash
pnpm --filter updl test
```

Набор тестов Vitest валидирует порты узлов Flowise и флаги сбора лидов, чтобы редакторский опыт соответствовал руководству README.

## Фокус модуля

Этот модуль намеренно сфокусирован **только на определениях узлов**:

-   **Без построителей пространств**: Обрабатывается системой публикации (`publish-frt`).
-   **Без логики экспорта**: Обрабатывается приложениями публикации.
-   **Без API-клиентов**: Не требуется для определений узлов.
-   **Без управления состоянием**: Узлы являются безсостоятельными определениями.

Это чистое разделение обеспечивает оптимальную архитектуру и поддерживаемость.

## Вклад

При вкладе в этот пакет:

1. Следуйте лучшим практикам TypeScript
2. Придерживайтесь 7 основных типов узлов UPDL
3. Добавляйте тесты для новых определений узлов или коннекторов
4. Обновляйте спецификации OpenAPI для интерфейсов узлов
5. Обновляйте документацию на EN и RU
6. Следуйте стандартам кодирования проекта

## Связанная документация

- [Документация основных приложений](../README-RU.md)
- [Фронтенд публикации](../publish-frt/base/README-RU.md)
- [Построитель пространств](../space-builder-frt/base/README-RU.md)
- [Шаблон MMOOMM](../template-mmoomm/base/README-RU.md)
- [Документация Flowise](https://docs.flowiseai.com/)

---

_Universo Platformo | Модуль UPDL_
