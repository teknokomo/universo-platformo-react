# `packages/publish-srv` ‚Äî Backend —Å–∏—Å—Ç–µ–º—ã –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ ‚Äî [–°—Ç–∞—Ç—É—Å: MVP]

> **üìã –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ**: –î–∞–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Flowise –∏ –≤ –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –¥–ª—è Universo Platformo.

## –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

Backend —Å–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è–º–∏, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤ UPDL –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –ø—É–±–ª–∏—á–Ω—ã—Ö URL –¥–ª—è –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ AR.js –∏ PlayCanvas.

## –†–æ–ª—å –≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ

-   –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å—è–º–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
-   –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å—ã—Ä—ã—Ö `flowData` –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
-   –≠–∫—Å–ø–æ—Ä—Ç –æ–±—â–∏—Ö UPDL –∏ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π TypeScript —Ç–∏–ø–æ–≤
-   –ü–æ–ª–Ω–∞—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ `packages/flowise-server`
-   –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–æ–≤ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π –≥–æ–Ω–∫–∏

## –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—É–±–ª–∏–∫–∞—Ü–∏—è–º–∏

-   **–°–æ–∑–¥–∞–Ω–∏–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–π**: API –∫–æ–Ω–µ—á–Ω—ã–µ —Ç–æ—á–∫–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–µ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ AR.js –∏ PlayCanvas
-   **–ü–æ–ª—É—á–µ–Ω–∏–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–π**: –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –ø—É–±–ª–∏—á–Ω—ã—Ö URL –¥–ª—è –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
-   **–ü–æ—Å—Ç–∞–≤—â–∏–∫ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Ç–æ–∫–∞**: –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å—ã—Ä—ã—Ö `flowData` –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
-   **–î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏**: –í—Å—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ UPDL –¥–µ–ª–µ–≥–∏—Ä—É–µ—Ç—Å—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—É

### –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ç–∏–ø—ã

-   **TypeScript —Ç–∏–ø—ã**: –≠–∫—Å–ø–æ—Ä—Ç –æ–±—â–∏—Ö UPDL —Ç–∏–ø–æ–≤ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ
-   **–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –ø—É–±–ª–∏–∫–∞—Ü–∏–∏**: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–π
-   **–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å —Ç–∏–ø–æ–≤**: –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è —Ç–∏–ø–æ–≤ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏

## API –∫–æ–Ω–µ—á–Ω—ã–µ —Ç–æ—á–∫–∏

### –°–æ–∑–¥–∞–Ω–∏–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏

#### AR.js –ø—É–±–ª–∏–∫–∞—Ü–∏—è

```
POST /api/v1/publish/arjs

Headers:
  Authorization: Bearer <jwt_token>

Body: {
  "canvasId": "uuid",
  "isPublic": true,
  "projectName": "My AR Experience",
  "libraryConfig": {
    "arjs": { "version": "3.4.7", "source": "kiberplano" },
    "aframe": { "version": "1.7.1", "source": "official" }
  },
  "renderConfig": {
    "arDisplayType": "wallpaper",
    "wallpaperType": "sphere"
  }
}

Response: {
  "success": true,
  "publicationId": "abc123",
  "publicUrl": "/p/arjs/abc123"
}
```

#### PlayCanvas –ø—É–±–ª–∏–∫–∞—Ü–∏—è

```
POST /api/v1/publish/playcanvas

Headers:
  Authorization: Bearer <jwt_token>

Body: {
  "canvasId": "uuid",
  "isPublic": true,
  "projectName": "My 3D Experience",
  "libraryConfig": { ... }
}

Response: {
  "success": true,
  "publicationId": "xyz789",
  "publicUrl": "/p/playcanvas/xyz789"
}
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—É–±–ª–∏–∫–∞—Ü–∏–∏

#### AR.js –ø—É–±–ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

```
GET /api/v1/publish/arjs/public/:publicationId

Response: {
  "success": true,
  "flowData": "{\"nodes\":[...],\"edges\":[...]}",
  "libraryConfig": {
    "arjs": { "version": "3.4.7", "source": "kiberplano" },
    "aframe": { "version": "1.7.1", "source": "official" }
  },
  "renderConfig": {
    "arDisplayType": "wallpaper",
    "wallpaperType": "sphere"
  }
}
```

#### PlayCanvas –ø—É–±–ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

```
GET /api/v1/publish/playcanvas/public/:publicationId

Response: {
  "success": true,
  "flowData": "{\"nodes\":[...],\"edges\":[...]}",
  "libraryConfig": { ... },
  "templateConfig": {
    "template": "mmoomm",
    "options": { ... }
  }
}
```

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Workspace –ø–∞–∫–µ—Ç–∞

Backend —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∫–∞–∫ **pnpm workspace –ø–∞–∫–µ—Ç**:

-   **–ò–º—è –ø–∞–∫–µ—Ç–∞**: `@universo/publish-srv`
-   **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ
-   **–≠–∫—Å–ø–æ—Ä—Ç—ã**: –ú–∞—Ä—à—Ä—É—Ç—ã, —Ç–∏–ø—ã, —Å–µ—Ä–≤–∏—Å—ã, –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã —á–µ—Ä–µ–∑ `src/index.ts`
-   **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–æ–≤**: –ò—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è UPDL —Ç–∏–ø–æ–≤, –ø–æ—Ç—Ä–µ–±–ª—è–µ–º—ã—Ö —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–∫–µ—Ç–∞

```
packages/publish-srv/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ controllers/        # –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã API
‚îÇ   ‚îú‚îÄ‚îÄ services/           # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ routes/             # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–æ–≤ Express
‚îÇ   ‚îú‚îÄ‚îÄ types/              # TypeScript —Ç–∏–ø—ã –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
‚îÇ   ‚îî‚îÄ‚îÄ index.ts            # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –ø–∞–∫–µ—Ç–∞
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ tsconfig.json
‚îî‚îÄ‚îÄ README.md
```

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–π

```sql
CREATE TABLE publications (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES auth.users(id),
    canvas_id UUID REFERENCES canvases(id),
    platform VARCHAR(50) NOT NULL, -- 'arjs' | 'playcanvas'
    public_id VARCHAR(255) UNIQUE NOT NULL,
    is_public BOOLEAN DEFAULT true,
    project_name VARCHAR(255),
    library_config JSONB,
    render_config JSONB,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å—Ç—Ä–æ–∫ (RLS)

```sql
-- –ü–æ–ª–∏—Ç–∏–∫–∞ —á—Ç–µ–Ω–∏—è: –ø—É–±–ª–∏—á–Ω—ã–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ–º
CREATE POLICY "Public publications are viewable by everyone"
ON publications FOR SELECT
USING (is_public = true);

-- –ü–æ–ª–∏—Ç–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è: —Ç–æ–ª—å–∫–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
CREATE POLICY "Users can create their own publications"
ON publications FOR INSERT
WITH CHECK (auth.uid() = user_id);

-- –ü–æ–ª–∏—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü
CREATE POLICY "Users can update their own publications"
ON publications FOR UPDATE
USING (auth.uid() = user_id);
```

## –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

–ú–∞—Ä—à—Ä—É—Ç—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π –≥–æ–Ω–∫–∏:

```typescript
// –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–æ–≤
export async function createPublishRoutes(): Promise<Router> {
    const router = Router()
    
    // –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ë–î
    await ensureDatabaseConnection()
    
    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–æ–≤
    router.post('/arjs', authenticateJWT, createARJSPublication)
    router.post('/playcanvas', authenticateJWT, createPlayCanvasPublication)
    router.get('/arjs/public/:id', getPublicARJSPublication)
    router.get('/playcanvas/public/:id', getPublicPlayCanvasPublication)
    
    return router
}
```

## –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞)
pnpm install

# –°–æ–±—Ä–∞—Ç—å workspace –ø–∞–∫–µ—Ç
pnpm --filter @universo/publish-srv build
```

### –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

```bash
# –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Å —Ä–µ–∂–∏–º–æ–º –Ω–∞–±–ª—é–¥–µ–Ω–∏—è
pnpm --filter @universo/publish-srv dev
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# Unit —Ç–µ—Å—Ç—ã
pnpm --filter @universo/publish-srv test

# Integration —Ç–µ—Å—Ç—ã
pnpm --filter @universo/publish-srv test:integration

# –õ–∏–Ω—Ç–∏–Ω–≥
pnpm --filter @universo/publish-srv lint
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

-   **JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**: –í—Å–µ –∫–æ–Ω–µ—á–Ω—ã–µ —Ç–æ—á–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è —Ç—Ä–µ–±—É—é—Ç –≤–∞–ª–∏–¥–Ω—ã–π JWT —Ç–æ–∫–µ–Ω
-   **RLS –ø–æ–ª–∏—Ç–∏–∫–∏**: –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –¥–æ—Å—Ç—É–ø–∞
-   **–í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**: –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –≤—Ö–æ–¥–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
-   **–ü—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø**: –¢–æ–ª—å–∫–æ –ø—É–±–ª–∏—á–Ω—ã–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

## –î–æ—Ä–æ–∂–Ω–∞—è –∫–∞—Ä—Ç–∞

### –§–∞–∑–∞ 1: –ë–∞–∑–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª ‚úÖ
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–π AR.js
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–π PlayCanvas
- ‚úÖ –ü—É–±–ª–∏—á–Ω—ã–µ URL –¥–ª—è –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞

### –§–∞–∑–∞ 2: –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
- ‚è≥ –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–π
- ‚è≥ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
- ‚è≥ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–æ–º–µ–Ω—ã

### –§–∞–∑–∞ 3: –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚è≥ CDN –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∞—Å—Å–µ—Ç–æ–≤
- ‚è≥ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—É–±–ª–∏—á–Ω—ã—Ö –ø—É–±–ª–∏–∫–∞—Ü–∏–π
- ‚è≥ Rate limiting –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö –∫–æ–Ω–µ—á–Ω—ã—Ö —Ç–æ—á–µ–∫

## –°–º. —Ç–∞–∫–∂–µ

- [Publish Frontend](./frontend.md) - –§—Ä–æ–Ω—Ç–µ–Ω–¥ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å–∏—Å—Ç–µ–º—ã –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
- [Publish README](./README.md) - –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
