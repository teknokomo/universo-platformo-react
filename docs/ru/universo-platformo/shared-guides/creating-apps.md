# Создание новых приложений и пакетов (Рекомендации)

Этот документ обобщает проверенные практики добавления фронтенд/бэкенд приложений и общих/шаблонных пакетов в монорепозитории.

## Импорты в рабочем пространстве

- Всегда импортируйте между пакетами по workspace-именам (например, `@universо/...`), а не относительными путями.
- Объявляйте `workspace:*` в `package.json` потребителя, чтобы корректно выстроить граф сборки.

## Порядок сборки (Turborepo)

- Держите `dependsOn: ["^build"]` на корне.
- Обеспечьте реальные зависимости в потребителях, чтобы шаблоны/библиотеки собирались до UI.
- Для cold start при необходимости добавьте зависимость сервера от `publish-frontend` (статические ассеты `/assets`).

## Фронтенд‑пакеты (TSX)

- TypeScript‑first. Двойная сборка (CJS + ESM + Types).
- Указывайте `main`, `module`, `types` и `exports` на `dist/*`.
- Компилированный вывод — в `dist/`.

## Бэкенд‑пакеты (TypeORM)

- Никаких прямых вызовов к БД‑клиенту. Используйте паттерн репозиториев через общий `DataSource`.
- Экспортируйте массивы `entities` и `migrations` для центральной регистрации.
- Монтируйте роутеры пакетов на основном сервере под корректными префиксами.

## Формат i18n

- Точка входа i18n — TypeScript (`index.ts`) для включения в `dist` и типобезопасности.
- Импортируйте JSON‑локали с `resolveJsonModule` или инлайните небольшие словари.
- Экспортируйте типизированные хелперы (`getXxxTranslations(lang)`), держите стабильные неймспейсы.

## Интеграция с Vite

- Сборка библиотек до `flowise-ui`.
- Используйте `optimizeDeps.include`/`build.commonjsOptions.include` умеренно для workspace‑пакетов.
- Избегайте алиасов на `src` в продакшн‑сборке (только dev‑fallback).

## Избегаем циклов

- Фичевые/фронтенд‑пакеты не должны зависеть от приложения UI.
- UI зависит от фичевых пакетов, а не наоборот.

## Дочерние модули Uniks

- Новые домены (например, Finance):
  - экспортируют массивы сущностей и миграций и `createXxxRouter()`;
  - монтируются на сервере под `/api/v1/uniks/:unikId/...`;
  - добавляют вложенные маршруты в UI и свой i18n‑неймспейс.

## Краткий чек‑лист

- Импорты по workspace‑именам `@universo/...`, зависимости `workspace:*`
- Двойная сборка (CJS/ESM/types), карта `exports` указывает в `dist/*`
- TS‑вход i18n (`src/i18n/index.ts`), JSON‑локали с `resolveJsonModule`
- Нет циклической зависимости с UI; UI зависит от вашего пакета, не наоборот
- Серверный пакет экспортирует `entities`, `migrations`, и `createXxxRouter()` при необходимости
- На корне Turborepo `dependsOn: ["^build"]`; потребители объявляют зависимости для порядка сборки
- Vite: не алиасить `src` в продакшене; собирать библиотеки до UI
