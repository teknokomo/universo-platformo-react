# Progress Log

> **Note**: Completed work with dates and outcomes. Active tasks ‚Üí tasks.md, architectural patterns ‚Üí systemPatterns.md.

---

## ‚ö†Ô∏è IMPORTANT: Version History Table

**The table below MUST remain at the top of this file. All new progress entries should be added BELOW this table.**

| Release | Date | Codename | Highlights |
|---------|------|----------|------------|
| 0.40.0-alpha | 2025-12-06 | Straight Rows üéπ | Tools, Credentials, Variables, ApiKey, Assistants, Leads, ChatMessage, DocumentStore, CustomTemplates extraction (9 packages), Canvases migrations consolidation, Admin Instances MVP, RBAC Global Roles |
| 0.39.0-alpha | 2025-11-26 | Mighty Campaign üßôüèø | Campaigns module, Storages module, useMutation refactor (7 packages), QA fixes |
| 0.38.0-alpha | 2025-11-22 | Secret Organization ü•∑ | Organizations module, Projects management system, AR.js Quiz Nodes, Member i18n refactor |
| 0.37.0-alpha | 2025-11-14 | Smooth Horizons üåÖ | REST API docs refactoring (OpenAPI 3.1), Uniks metrics update, UnikBoard 7 metrics, Clusters breadcrumbs |
| 0.36.0-alpha | 2025-11-07 | Revolutionary indicators üìà | Date formatting migration to dayjs, TypeScript refactor, publish-frontend architecture, Dashboard analytics charts |
| 0.35.0-alpha | 2025-10-30 | Bold Steps üíÉ | i18n TypeScript migration, Type safety improvements, Rate limiting with Redis, RLS integration analysis |
| 0.34.0-alpha | 2025-10-23 | Black Hole ‚òïÔ∏è | Global monorepo refactoring, tsdown build system, dependencies centralization |
| 0.33.0-alpha | 2025-10-16 | School Test üíº | Publication System 429 fixes, API modernization, Metaverses refactoring, Quiz timer |
| 0.32.0-alpha | 2025-10-09 | Straight Path üõ¥ | Canvas versioning, Chatflow‚ÜíCanvas terminology, PostHog telemetry, Metaverses pagination |
| 0.31.0-alpha | 2025-10-02 | Victory Versions üèÜ | Manual quiz editing, Unik deletion cascade, Space Builder modes, Material-UI template |
| 0.30.0-alpha | 2025-09-21 | New Doors üö™ | TypeScript path aliases, Global publication library, Analytics selectors |
| 0.29.0-alpha | 2025-09-15 | Cluster Backpack üéí | Cluster isolation architecture, i18n docs checker, GitHub Copilot modes |
| 0.28.0-alpha | 2025-09-07 | Orbital Switch ÔøΩÔøΩ | Metaverses dashboard, Universal List Pattern |
| 0.27.0-alpha | 2025-08-31 | Stable Takeoff üê£ | Language switcher, MMOOMM template, Finance module |
| 0.26.0-alpha | 2025-08-24 | Slow Colossus üêå | MMOOMM modular package, Multiplayer Colyseus server |
| 0.25.0-alpha | 2025-08-17 | Gentle Memory üòº | Space Builder MVP, Metaverse module, @universo/types |

---

## üìÖ 2025-12-11

### ESLint Configuration Upgrade ‚úÖ

**Context:** Fixed TypeScript ESLint compatibility warning by upgrading to supported versions.

**Technical Details:**
- Upgraded `@typescript-eslint/eslint-plugin` from 7.13.1 to 8.49.0
- Added `@typescript-eslint/parser` 8.49.0 (replacement for typescript-estree)
- Upgraded `eslint-plugin-unused-imports` from 2.0.0 to 4.3.0
- Updated ESLint configuration to use TypeScript overrides instead of global extends

**Results:**
- ‚úÖ Eliminated "unsupported TypeScript version" warning (5.8.3 now supported)
- ‚úÖ All TypeScript files now lint correctly with proper type checking
- ‚úÖ No breaking changes to existing lint rules
- ‚úÖ All packages maintain consistent linting standards

**Impact:** Development environment now runs cleanly without deprecation warnings, ensuring consistent code quality across the TypeScript codebase.

---

## December 2025

### 2025-12-11: UUID v7 QA Verification ‚úÖ

**Context**: Deep investigation and QA verification of UUID v7 implementation to ensure TypeORM compatibility and data integrity.

**QA Activities**:
1. **Database Schema Verification**: Queried `information_schema.columns` to confirm all 75+ tables have `DEFAULT uuid_generate_v7()` - ‚úÖ Verified
2. **Data Integrity Check**: Sampled existing records from `admin.roles`, `metaverses.*`, `organizations.*` - all have UUID version 7 - ‚úÖ Verified
3. **TypeORM Behavior Analysis**: 
   - Examined TypeORM source code (PostgresDriver, PostgresQueryRunner)
   - Confirmed `uuidGenerator` getter is used ONLY for DDL operations (CREATE/ALTER TABLE)
   - Verified TypeORM does NOT generate UUIDs client-side during INSERT
   - During `repository.save()` without id, TypeORM executes `INSERT ... RETURNING *` and PostgreSQL generates UUID via DEFAULT clause
4. **Configuration Audit**: Confirmed `synchronize: false` in DataSource prevents schema override
5. **Web Research**: Analyzed TypeORM GitHub issues (#11571, #7663) confirming default uuid_generate_v4() behavior and lack of custom UUID strategy support

**Findings**:
- ‚úÖ `@PrimaryGeneratedColumn('uuid')` decorator is fully compatible with `uuid_generate_v7()` DEFAULT
- ‚úÖ Raw SQL migrations successfully override TypeORM's default uuid_generate_v4() behavior
- ‚úÖ No client-side UUID generation - all UUIDs generated by PostgreSQL
- ‚ö†Ô∏è Future warning: If using `typeorm migration:generate`, manually edit to use uuid_generate_v7()

**Documentation Updated**:
- `techContext.md`: Added "TypeORM Compatibility (QA Verified 2025-12-11)" section with detailed behavior explanation
- `activeContext.md`: Updated Current Focus to "UUID v7 QA Complete" with findings summary

**Outcome**: UUID v7 implementation verified as fully working. No code changes required.

---

### 2025-12-10: UUID v7 Migration ‚úÖ

**Context**: Migrated entire project from UUID v4 to UUID v7 for better database indexing performance (30-50% faster).

**Changes**:
1. **Infrastructure** (Etap 0): Created `@universo/utils/uuid` module with `generateUuidV7()`, `isValidUuid()`, `extractTimestampFromUuidV7()` functions. Updated TypeORM 0.3.6 ‚Üí 0.3.28 (removed override). Added `uuidv7: ^1.1.0` to catalog.
2. **Database Function** (Etap 2): Added PostgreSQL `uuid_generate_v7()` function in first migration (`1733400000000-CreateAdminSchema.ts`).
3. **Migrations** (Etap 3): Updated 75 migration files - replaced `uuid_generate_v4()` and `gen_random_uuid()` ‚Üí `public.uuid_generate_v7()`.
4. **Backend Services** (Etap 4): Updated 24 backend files - replaced `randomUUID()` from crypto and `{ v4 as uuidv4 } from 'uuid'` with `uuid.generateUuidV7()` from `@universo/utils`.
5. **Frontend** (Etap 5): Updated 7 frontend files - replaced `{ v4 as uuidv4 } from 'uuid'` with `{ uuidv7 } from 'uuidv7'`. Added UUID validation helper in `LoaderConfigPreviewChunks.jsx`.

**Technical Details**:
- UUID v7 format: 48-bit timestamp + 12-bit version/variant + 62-bit random
- Time-ordered nature improves B-tree index performance
- Database function uses PL/pgSQL with `gen_random_bytes()` and bitwise operations
- Backend packages use centralized `@universo/utils/uuid` module
- Frontend packages use direct `uuidv7` npm package for bundle size

**Files Modified**: 109 files across 25 packages (migrations: 75, backend: 24, frontend: 7, config: 3)

**Performance Impact**: Estimated 30-50% improvement in UUID primary key indexing operations based on industry benchmarks.

---

### 2025-12-10: Legacy Code Cleanup ‚úÖ

**Context**: Post-RBAC cleanup - fixed outdated comments and legacy naming conventions.

**Changes**: Updated 4 files in admin-frontend (`has_global_access = true` ‚Üí `is_superuser = true` in comments), updated systemPatterns.md (removed deleted SQL function reference), enhanced deprecation warning in `adminConfig.ts`.

**Files**: 6 files modified (admin-frontend, universo-utils, memory-bank)

---

### 2025-12-09: Global Roles Access Implementation ‚úÖ

**Summary**: Fixed architecture separating `hasAdminAccess` (admin panel) from `hasGlobalSubjectAccess` (view all data). Users with subject-specific permissions (e.g., `metaverses:*`) can now access all items of permitted subjects.

**Key Fixes**: (1) Guard bypass - `ensureMetaverseAccess` checks global permissions before membership, (2) Legacy SQL - replaced `admin.has_global_access()` ‚Üí `admin.is_superuser()`, (3) Sections dropdown context-awareness.

**Modified**: 13 files (metaverses-backend, metaverses-frontend, auth-backend, flowise-store)

---

### 2025-12-08: CASL Standard Compliance ‚úÖ

**Goal**: Align permission system with CASL/Auth0/OWASP standards by renaming `module` ‚Üí `subject`.

**Changes**: 21 files - database migration (column rename, SQL functions), TypeScript types, backend services, frontend (PermissionMatrix 13 changes), i18n (EN/RU).

**Critical Bug Fixed**: TypeError in InstanceUsers.tsx - `queryKey` ‚Üí `queryKeyFn` parameter mismatch.

**Architecture**: `subject` field now used throughout (e.g., `roles:read`, `metaverses:*`).

---

### 2025-12-07: RBAC Architecture Cleanup ‚úÖ

**Goal**: Remove `canAccessAdmin` flag redundancy - admin access now computed from RBAC permissions.

**Rule**: `IF user has READ permission on ANY of ['roles', 'instances', 'users'] THEN hasAdminAccess = true`

**Changes**: 18 files - dropped database column, added SQL function `admin.has_admin_permission()`, updated frontend hooks/UI.

---

### 2025-12-07: Roles UI Unification ‚úÖ

**Summary**: Refactored RolesList to use unified pattern (MetaverseList style) with card/table views, pagination, search, BaseEntityMenu.

**Implementation**: Created RoleActions with `createEntityActions` factory, added direct exports to rolesApi, implemented full unified pattern with `usePaginated` hook.

**Features**: Card view (color indicator, badges, permissions count), table view (FlowListTable), permission filtering, localStorage persistence.

---

### 2025-12-06: Admin Instances Module MVP ‚úÖ

**Summary**: Created Instances management with single pre-seeded "Local" instance, simplified left menu, context menu inside instance.

**Routes**: `/admin` (InstanceList), `/admin/instance/:id` (InstanceBoard), `/admin/instance/:id/access` (InstanceAccess).

**Implementation**: Entity/migration, backend routes, frontend API/hooks/pages, navigation integration, i18n (EN/RU).

---

### 2025-12-05: Dynamic Global Roles System ‚úÖ

**Goal**: Replace hardcoded `'superadmin' | 'supermoderator'` with dynamic database-driven roles.

**Changes**: Added `display_name` (JSONB), `color`, `has_global_access` to `admin.roles`, created SQL functions `admin.has_global_access()`, `admin.get_user_global_roles()`, updated API endpoints with `roleMetadata`.

**Frontend**: AbilityContextProvider provides `globalRoles`, `rolesMetadata`, `hasGlobalAccess`; RoleChip accepts `roleMetadata` for dynamic colors.

---

### 2025-12-04: User Settings System ‚úÖ

**Goal**: Allow superadmin to toggle "show only my items" vs "show all items".

**Implementation**: Backend (profile-backend with settings JSONB column, GET/PUT endpoints), Frontend (useUserSettings hook, SettingsDialog component), Route updates (showAll query parameter in metaverses, sections, entities).

**Pattern**: `showAll=true` ‚Üí LEFT JOIN, `showAll=false` ‚Üí INNER JOIN (membership filter).

**Build**: 52/52 packages ‚úÖ

---

### 2025-12-03: Admin Packages (Superadmin/Supermoderator) ‚úÖ

**Summary**: Created `@universo/admin-backend` and `@universo/admin-frontend` for global user management.

**Features**: Global roles (superadmin full CRUD, supermoderator read-only), ENV control (`SUPER_USERS_MODE`), separate `admin` schema with RLS, API endpoints, menu integration.

**Architecture**: Local apiClient in admin-frontend (avoid cyclic deps), useGlobalRoleCheck hook, PageCard component usage.

---

## November 2025

### 2025-11-26: Campaigns Integration ‚úÖ

**Summary**: Three-tier architecture implementation (campaigns-backend, campaigns-frontend, @universo/api-client).

**Routes**: `/campaign/:campaignId/*` with Board and Access pages, full CRUD operations.

---

### 2025-11-25: Storages Management ‚úÖ

**Summary**: Three-tier architecture for storage management system.

**Implementation**: Zod validation, RLS policies, storage types (personal/organization), member management.

---

### 2025-11-22: Organizations Module ‚úÖ

**Summary**: Organizations management with Projects hierarchy, breadcrumbs navigation.

**Features**: OrganizationBoard, OrganizationMembers, organization-project relationship, i18n Member keys refactor.

---

### 2025-11-18: Projects Management System ‚úÖ

**Summary**: Hierarchical project structure with milestones terminology.

**Router**: Registered, 23 issues fixed, all pages loading, terminology unified throughout UI.

---

### 2025-11-14: REST API Documentation Refactoring ‚úÖ

**Summary**: Modular OpenAPI 3.1 structure with Zod validation.

**Changes**: Workspace ‚Üí Unik terminology, description fields added, modular schema structure.

---

### 2025-11-13: Uniks Module Expansion ‚úÖ

**Summary**: UnikBoard expanded from 3 to 7 metric cards, metrics update (Spaces/Tools counts), Clusters breadcrumbs with useClusterName hook.

**Refactor**: Switched from chatflows to spaces metrics, createAccessGuards factory pattern.

---

## October 2025

### 2025-10-30: Bold Steps üíÉ (v0.35.0-alpha) ‚úÖ

**Summary**: i18n TypeScript migration, type safety improvements, Rate limiting with Redis, RLS integration analysis.

**Changes**: 30+ packages migrated to TypeScript i18n, Redis rate limiter implementation, RLS pattern documentation.

---

### 2025-10-23: Black Hole ‚òïÔ∏è (v0.34.0-alpha) ‚úÖ

**Summary**: Global monorepo refactoring, tsdown build system implementation, dependencies centralization.

**Changes**: Package restructuring, dual build (CJS + ESM), workspace dependencies optimization.

---

### 2025-10-16: School Test üíº (v0.33.0-alpha) ‚úÖ

**Summary**: Publication System 429 fixes, API modernization, Metaverses architecture refactoring, Quiz timer feature.

**Changes**: Rate limiting implementation, REST API updates, Quiz interactive timer.

---

### 2025-10-09: Straight Path üõ¥ (v0.32.0-alpha) ‚úÖ

**Summary**: Canvas versioning, Chatflow‚ÜíCanvas terminology refactoring, PostHog telemetry (opt-in), Metaverses pagination.

**Changes**: Canvas metadata editing, terminology alignment, analytics integration.

---

### 2025-10-02: Victory Versions üèÜ (v0.31.0-alpha) ‚úÖ

**Summary**: Manual quiz editing workflow, Unik deletion cascade fixes, Space Builder modes, Material-UI template system.

**Changes**: Quiz editing UI, cascading delete fixes, Space Builder view modes.

---

## September 2025

### 2025-09-21: New Doors üö™ (v0.30.0-alpha) ‚úÖ

**Summary**: TypeScript path aliases standardization, Global publication library management, Analytics hierarchical selectors.

**Changes**: `@/*` path aliases, publication CRUD, multi-level analytics filtering.

---

### 2025-09-15: Cluster Backpack üéí (v0.29.0-alpha) ‚úÖ

**Summary**: Resources/Entities cluster isolation architecture, i18n docs consistency checker, GitHub Copilot modes.

**Changes**: Cluster-level resource isolation, documentation tooling, AI-assisted development modes.

---

### 2025-09-07: Orbital Switch ü•® (v0.28.0-alpha) ‚úÖ

**Summary**: Metaverses dashboard implementation, Universal List Pattern establishment.

**Changes**: Metaverse metrics dashboard, reusable list pattern for all entity types.

---

## August 2025

### 2025-08-31: Stable Takeoff üê£ (v0.27.0-alpha) ‚úÖ

**Summary**: Language switcher, MMOOMM template, Finance module.

**Changes**: EN/RU language toggle, metaverse template, financial tracking module.

---

### 2025-08-24: Slow Colossus üêå (v0.26.0-alpha) ‚úÖ

**Summary**: MMOOMM modular package, Multiplayer Colyseus server integration.

**Changes**: Template package extraction, real-time multiplayer server setup.

---

### 2025-08-17: Gentle Memory üòº (v0.25.0-alpha) ‚úÖ

**Summary**: Space Builder MVP, Metaverse module, @universo/types foundation.

**Changes**: Initial Space Builder functionality, Metaverse entity system, shared types package.

---

## July 2025 and Earlier (Condensed Archive)

### Major Milestones (0.20-0.24)

- **0.24.0-alpha**: Space Builder enhancements, UPDL nodes expansion, AR.js wallpaper mode
- **0.23.0-alpha**: Russian documentation translation, UPDL conditional params
- **0.22.0-alpha**: Memory Bank rules establishment, MMOOMM laser mining feature
- **0.21.0-alpha**: Handler refactoring, PlayCanvas stabilization
- **0.20.0-alpha**: UPDL node refactoring, Template-First architecture

### Foundation Phase (0.10-0.19)

- Flowise integration and customization
- Supabase authentication system
- UPDL (Universal Platform Description Language) basics
- Initial RLS policies and security model
- Core entity system (Metaverses, Clusters, Projects)

---

## Architecture Decisions & Patterns

### Package Extraction Strategy (November 2025)

**Standard Approach**:
1. Create backend package with entity, migration, DI service
2. Create frontend package with pages, i18n
3. Update flowise-server imports
4. Delete legacy files
5. Build and verify

**DI Factory Pattern**: All new packages use `createXxxService(config)` with dataSource, optional providers, callbacks.

---

### Key Technical Decisions

**TypeORM Repository Pattern**: All DB access via `getDataSource().getRepository(Entity)`, user context for RLS policies, no direct SQL.

**TanStack Query v5**: Query key factories, useQuery for fetching, useMutation for state changes (replaced custom useApi).

**i18n Architecture**: Core namespaces in @universo/i18n, feature packages own translations, registerNamespace for runtime.

**Build System**: pnpm workspace (run from root), tsdown dual output (CJS + ESM), path aliases `@/*`.

---

### Known Issues & Workarounds

**Template MUI CommonJS** (DEFERRED): flowise-ui ESM/CJS conflict, workaround via direct source imports.

**React StrictMode**: Conditional wrapper (dev only) to avoid double-mount issues.

---

## Statistics

**Package Evolution**:
- August 2025: 25 packages
- November 2025: 46 packages
- December 2025: 52 packages (current)

**Build Performance**: Full workspace build ~4-6 minutes depending on cache state.

---

**Last Updated**: 2025-12-10

**Note**: For current work ‚Üí tasks.md. For patterns ‚Üí systemPatterns.md.
