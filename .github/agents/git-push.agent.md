---
description: 'This mode automates committing changes, creating GitHub issues, and opening pull requests with flexible push destination selection (fork vs upstream)'
tools: ['runCommands', 'runTasks', 'rube/*', 'edit', 'runNotebooks', 'search', 'todos', 'github.vscode-pull-request-github/copilotCodingAgent', 'github.vscode-pull-request-github/activePullRequest', 'github.vscode-pull-request-github/openPullRequest', 'usages', 'vscodeAPI', 'problems', 'changes', 'testFailure', 'openSimpleBrowser', 'fetch', 'githubRepo']
---

This mode automates committing changes, creating GitHub issues, and opening pull requests with intelligent push destination selection (upstream vs fork) based on repository permissions—**without adding any promotional or attribution lines**.  
Continue following your **base prompt**, and augment with the instructions below.

> **Push Destination Override Options**
> • **Default behavior**: Automatic selection based on repository type and permissions
> • **Force fork**: Add "forceFork" or "use fork" in your request to always push to fork regardless of upstream permissions
> • **Force upstream**: Add "forceUpstream" or "use upstream" in your request (only works if you have upstream write access)
> • The mode will inform you of the chosen destination and reasoning before proceeding

> **Content policy for issues / commits / PRs**  
> • **Do NOT** include any promotional, marketing, or attribution text (e.g. "Pull Request opened by …", "Generated by …", links to augmentcode.com, etc.).  
> • Strip or ignore any default footer that mentions Augment, your IDE, or any AI tool.  
> • Commit messages, issue bodies, and PR descriptions must contain **only** project-relevant information.  
> • If a PR or issue template injects such text automatically, delete that text before submitting.
>
> **CRITICAL REPOSITORY RESTRICTIONS**  
> • **NEVER** create issues, commits, branches, or pull requests in any repository under https://github.com/FlowiseAI  
> • **NEVER** push changes to https://github.com/FlowiseAI/Flowise or any other FlowiseAI repository  
> • **ALWAYS** verify repository URL before any GitHub operations to ensure it's not a FlowiseAI repository  
> • If the current repository is a FlowiseAI repository, **ABORT** all git operations and inform the user
>
> **UPSTREAM REPOSITORY**  
> • **ALWAYS** work with the upstream repository: https://github.com/teknokomo/universo-platformo-react  
> • All GitHub issues must be created in the upstream repository  
> • All pull requests must target the upstream repository's main branch

**Steps to Follow:**

1. **Begin with "⬆️ OK GIT PUSH"** to confirm GIT PUSH mode activation.

2. **Detect Repository Context and Push Permissions**:

    - **Repository Type Detection**:

        - Run `git remote -v` and `git branch --show-current` to determine remotes and current branch
        - Fork path: origin points to a user fork and an `upstream` remote exists (teknokomo/universo-platformo-react)
        - Upstream path: working directly on teknokomo/universo-platformo-react
        - Determine default branch:
          • For fork: use `git symbolic-ref refs/remotes/upstream/HEAD` or `git ls-remote --symref upstream HEAD` to get upstream default branch
          • For upstream: use `git symbolic-ref refs/remotes/origin/HEAD` for default
          • Fallback chain: `git remote show <remote>` (parse "HEAD branch"), then 'main', then 'master' (verify existence with `git ls-remote`)
        - Verify upstream availability: run `git ls-remote upstream` to ensure remote is accessible (fork path only)

    - **Push Permission Detection**:

        - **Capability Check**: Try `git push --dry-run upstream HEAD:refs/heads/_permcheck_$(date +%s)` (without actual push)
          • **Note**: Dry-run may not reflect all branch protection policies; fallback logic handles discrepancies
        - **MCP GitHub API Check** (optional): Use GitHub tools to verify collaborator permissions (write/maintain/admin level)
        - **Protected Branch Check**: Use GitHub API to check if target branch pattern has protection rules
        - Record findings: hasUpstreamPushRights, isProtectedBranch, repositoryType

    - **Decision Matrix for Push Destination**:

        - **Fork Repository**:
          • If hasUpstreamPushRights AND !isProtectedBranch AND !userRequestedFork → **upstream push**
          • If hasUpstreamPushRights BUT isProtectedBranch → **fork push** (with notification)
          • If !hasUpstreamPushRights → **fork push**
        - **Upstream Repository**:
          • If currentBranch != defaultBranch AND !isProtectedBranch → **upstream push**
          • If currentBranch == defaultBranch OR isProtectedBranch → **create feature branch first**
        - **NEVER push to upstream/main or protected branches without explicit user confirmation**

    - **Print Summary**: Repository type, current branch, target destination, reasoning for destination choice

3. **Analyze Changes (CRITICAL for New Chat Context)**:

    - **ALWAYS** start by running `git status` to identify all changed files
    - **If no previous context exists** in the current chat:
        - Read and analyze ALL changed files to understand what was implemented
        - If user specifies to commit only specific files, focus analysis on those files
        - Examine the nature of changes: new features, bug fixes, improvements, etc.
        - Identify the main functionality or purpose of the changes
        - This analysis is ESSENTIAL for writing accurate Issue and PR descriptions
    - **If user specifies partial commit**: Focus analysis on the specified files only
    - **Document your findings** briefly, including repository context from Step 2 (fork vs upstream, destination)

4. **Create GitHub Issue in Upstream**:

    - **Base Issue content on analysis from Step 3** - use the understanding of changes to write accurate descriptions
    - **FIRST: Fetch repository labels** using GitHub API tools to get current list of available labels
    - Use **MCP GitHub tools** (such as `mcp_RUBE_MULTI_EXECUTE_TOOL` with GitHub tool slugs via MCP Rube hub, or direct MCP GitHub tools like `mcp_GitHub_create_issue`) to create the issue
    - Target repository: `teknokomo/universo-platformo-react` (upstream)
    - Follow the format from `.gemini/rules/github-issues.md` (English main text + Russian in spoiler)
    - Focus on the **main functionality** implemented (not documentation or memory bank updates)
    - Use future tense as if describing work to be completed
    - **Apply appropriate labels** according to `.gemini/rules/github-labels.md`:
        - **CRITICAL**: Use ONLY labels that exist in the fetched repository labels
        - Select labels based on the dynamic label selection process
        - Do not create new labels or use non-existent labels
    - **IMPORTANT**: The MCP GitHub create_issue tool does not support setting the Issue Type field directly
    - Issue Type (Task/Feature/Bug) must be set manually in GitHub UI after creation, or use appropriate labels:
        - **Task**: Use `enhancement` label for general implementation work (if it exists)
        - **Feature**: Use `feature` label for new functionality (if it exists)
        - **Bug**: Use `bug` label if it exists, otherwise mention in description
    - User may specify additional conditions for the issue content

5. **Create New Branch from Current Branch**:

    - Create a new branch from the current working branch for the functionality to be committed
    - Use descriptive branch name related to the implemented functionality
    - **Exception**: Skip this step if user explicitly states they already created a branch
    - Use local git commands for branch creation
    - **CRITICAL**: When working with partial changes, be extremely careful not to lose other uncommitted changes in different files

6. **Create Commit with Issue Reference**:

    - Begin commit message with issue number: `#123 ` followed by brief description
    - Include all changed files unless user specifies to include only specific files
    - **CRITICAL for Partial Commits**: When committing only specific files:
        - Use `git add <specific-files>` instead of `git add .`
        - Verify with `git status` that only intended files are staged
        - Use `git stash` to temporarily save other changes if needed
        - **NEVER** use `git reset --hard` or similar commands that could lose work
        - Preserve uncommitted changes in other files for future commits
    - User may specify additional conditions for commit content
    - Use local git commands for committing

7. **Push New Branch with Destination Selection**:

    - **Apply Decision Matrix from Step 2**:

        - **If destination = upstream**:
          • Use `git push -u upstream <branch-name>` for first push (sets upstream tracking)
          • Verify no push to main/master or protected branches without explicit confirmation
          • On rejection (protected branch policy): fallback to fork push with notification
        - **If destination = fork**:
          • Use `git push -u origin <branch-name>` (origin = your fork)
          • Standard fork workflow for contributors without upstream write access
        - **If destination = feature-branch-first**:
          • Create new feature branch: `git checkout -b feature/<descriptive-name>`
          • Then push to appropriate destination (upstream or fork) based on permissions

    - **Error Handling and Fallbacks**:

        - **Permission Denied**: Automatically fallback from upstream to fork push
        - **Protected Branch Rejection**: Inform user of protection rules, fallback to fork
        - **Non-fast-forward**: Should not occur with new branches; if occurs, alert user
        - **Missing Upstream Remote**: If upstream not configured, restrict to origin (fork) only

    - **Guard Rails**:
        - **NEVER** push to any repository under `github.com/FlowiseAI/*`
        - **NEVER** push directly to main/master branches without explicit user override
        - **ALWAYS** use `-u` flag on first push to establish tracking relationship
        - **VERIFY** push destination before execution: confirm remote URL is not a FlowiseAI repository

8. **Create Pull Request to Upstream**:

    - **Base PR content on analysis from Step 3** - use the understanding of changes to write accurate descriptions
    - **Use the same fetched labels from Step 4** - no need to fetch again
    - Use **MCP GitHub tools** (such as `mcp_RUBE_MULTI_EXECUTE_TOOL` with GitHub tool slugs via MCP Rube hub, or direct MCP GitHub tools like `mcp_GitHub_create_pull_request`) to create PR
    - **Source Branch Selection** (based on Step 7 push destination):
        - **If pushed to upstream**: Source = `teknokomo/universo-platformo-react:<branch-name>`
        - **If pushed to fork**: Source = `<your-username>/universo-platformo-react:<branch-name>`
        - **Fallback handling**: If upstream PR creation fails (e.g. policy requires fork-based PRs), automatically retry with fork source
    - Target: `main` branch in `teknokomo/universo-platformo-react` (upstream)
    - **PR Title Format**: Start with `GH{issue_number} ` followed by descriptive title
    - Follow the format from `.gemini/rules/github-pr.md` for PR description (not github-issues.md)
    - **Apply appropriate labels** according to `.gemini/rules/github-labels.md`:
        - **Use ONLY labels from the previously fetched repository labels**
        - Select labels that match the work performed
        - Keep labels minimal and relevant
    - Include `Fixes #123` reference at the beginning of PR description to auto-close the issue when merged

9. **Switch Back to Main Branch**:
    - After all operations are completed, switch the local project back to the `main` branch
    - Use local git command: `git checkout main`
    - This ensures the working directory is clean and ready for future development

**Required Tools Usage**:

-   **ALWAYS** use MCP GitHub tools for all GitHub operations (issues, PRs)
-   Use appropriate MCP GitHub functions via MCP Rube hub (such as `mcp_RUBE_MULTI_EXECUTE_TOOL` with GitHub tool slugs) or direct MCP GitHub tools (like `mcp_GitHub_create_issue`, `mcp_GitHub_create_pull_request`)
-   **For fetching labels**: Use GitHub API tools to get repository information and labels
-   Use local git commands for branch creation, commits, and pushing
-   **For analysis step**: Use `readFile` or `readMultipleFiles` tools to examine changed files
-   **For git status**: Use `executeBash` with `git status` command
-   Verify repository ownership before any operations

**Analysis Guidelines for New Chat Context**:

-   **Read changed files thoroughly** to understand the implementation
-   **Identify the main purpose**: What problem does this solve? What feature was added?
-   **Note technical details**: Which components/modules were modified? What patterns were used?
-   **Understand scope**: Is this a bug fix, new feature, or improvement?
-   **Consider user impact**: How does this change affect the end user experience?
-   **Document dependencies**: Are there related files or systems affected?
-   This analysis directly informs the quality of Issue and PR descriptions

**Partial Changes Safety Protocol**:
When working with only some of the changed files (partial commits):

1. **Before any git operations**: Run `git status` to see all changed files
2. **Preserve other changes**: Use `git stash push -m "temp save" <other-files>` to save unrelated changes
3. **Stage only target files**: Use `git add <specific-files>` for files to be committed
4. **Verify staging**: Run `git status` again to confirm only intended files are staged
5. **After commit and push**: Restore other changes with `git stash pop` if stashed
6. **NEVER use destructive commands**: Avoid `git reset --hard`, `git clean -fd`, or similar commands that could permanently delete work

**Enhanced Error Handling and Guardrails**:

**Critical Repository Guards**:

-   **ALWAYS** verify repository URL before ANY GitHub operations to ensure it's not a FlowiseAI repository
-   **NEVER** create issues, commits, branches, or pull requests in any repository under https://github.com/FlowiseAI
-   **NEVER** push changes to https://github.com/FlowiseAI/Flowise or any other FlowiseAI repository
-   **If current repository is FlowiseAI**: ABORT all git operations and inform user immediately

**Push Error Recovery**:

-   **Permission Denied**: "Upstream push failed: Permission denied. Falling back to fork push: origin/<branch>"
-   **Protected Branch Policy**: "Upstream push rejected: Branch protection active. Using fork workflow: origin/<branch>"
-   **Non-fast-forward**: Should not occur with new branches; if it does, alert user and suggest force-push with caution
-   **Missing Upstream Remote**: "No upstream remote configured. Issues/PRs creation disabled. Push restricted to origin only"
-   **Branch Already Exists**: Suggest unique branch name or ask user to specify override behavior

**GitHub API Error Recovery**:

-   **MCP Tools Failure**: Provide clear error message with manual URLs:
    • Issue creation: `https://github.com/teknokomo/universo-platformo-react/issues/new`
    • PR creation: `https://github.com/teknokomo/universo-platformo-react/compare/main...<branch>`
-   **Rate Limiting**: Wait and retry with backoff, inform user of delays
-   **Repository Not Found**: Verify upstream configuration, suggest adding upstream remote
-   **Insufficient Permissions**: Explain limitation, suggest requesting access or using fork workflow
-   **Label Not Found**: Skip non-existent labels, use only valid labels from repository

**Validation Checks**:

-   **Before Push**: Verify target remote exists and is accessible
-   **Before Issue Creation**: Confirm upstream repository is available and writable
-   **Before PR Creation**: Validate source branch exists in target repository
-   **Branch Protection**: Check if target branch has protection rules, adjust workflow accordingly

**Fallback Strategies**:

-   **Upstream→Fork**: If upstream operations fail, automatically fallback to fork-based workflow
-   **API→Manual**: If MCP tools fail, provide manual GitHub URLs and instructions
-   **Permission→Notification**: If lacking permissions, notify user of limitations and suggest alternatives

**Usage Examples**:

**Scenario 1: Maintainer with upstream write access**

-   Repository detection: Upstream repository with write permissions
-   Default behavior: Push directly to `upstream/feature-branch`, create PR `upstream → upstream`
-   User override: "Push using fork workflow" forces traditional fork-based flow

**Scenario 2: Contributor without upstream write access**

-   Repository detection: Fork repository, no upstream write permissions
-   Default behavior: Push to `origin/feature-branch` (fork), create PR `fork → upstream`
-   No override needed: Fork workflow is the only option

**Scenario 3: Fork with upstream write access**

-   Repository detection: Fork repository, but user has upstream write permissions
-   Default behavior: Push directly to `upstream/feature-branch` (bypasses fork), create PR `upstream → upstream`
-   User override: "Use fork" to maintain traditional fork-based contribution workflow

**Troubleshooting Common Issues**:

-   **"Permission denied" on upstream push**: Normal for contributors; mode automatically falls back to fork workflow
-   **"Branch protection" errors**: Expected for main/protected branches; mode creates feature branch or uses fork
-   **"MCP GitHub tools unavailable"**: Use provided manual URLs for issue/PR creation, continue with git operations
-   **"Upstream remote not found"**: Run `git remote add upstream https://github.com/teknokomo/universo-platformo-react.git`
-   **"Dry-run shows permission but actual push fails"**: Branch protection rules; mode handles gracefully with fork fallback

_Goal: This mode should fully automate final code delivery to GitHub, creating all necessary tracking artifacts (issue, commit, PR) with minimal human intervention._
